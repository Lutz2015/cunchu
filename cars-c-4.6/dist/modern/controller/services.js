define(function(require,exports,module){function a(){var a=$("#services .j-dialog");a.length>0&&a.remove(),f._init(),b.toggleContent("#services")}require("template/service_list"),require("template/service_info"),require("template/service"),require("template/services_table");var b=window.sharp,c=require("widget/dialog/js/dialog"),d=$("#services .content");if(b.isBox)var e=0;else var e=45;var f={_init:function(){var a=this;a._otherInfoData=b.getLocalData("otherInfo"),a._renderHead(),a.orderInfo={},$(".j-services-price-num").text(0),$(".j-price-button").addClass("disabled"),a._renderMain()},_renderHead:function(){if(b.isBox)return document.title="选择服务",!1;var a=require("widget/head/js/head");a.init({hasBack:1,title:"选择服务",dom:"#services .comhead",opt:0})},_renderMain:function(){var a=this,b=a._otherInfoData.currentCar,c=a._otherInfoData.currentShop,e={logo:b.logo,cname:b.cname,uccode:b.uccode,sname:c.sp_name,saddress:c.sp_address,carLogo:carLogo};dust.render("template/service",e,function(b,c){d.html(c),a._bindEvent()})},_disableServicesHtml:function(){$(".j-services-listdom").html("").addClass("hide"),$(".j-services-carelist").html(""),$(".j-services-price-num").text(0),$(".j-price-button").addClass("disabled")},_bindEvent:function(){var a=this,c=a._otherInfoData;$(".j-price-button").on("click",function(c){c.preventDefault(),$(c.currentTarget).hasClass("disabled")||(a._cacheData(),b.setLocalData("orderInfo",a.orderInfo),location.href="#payorder/")});var d=$(".j-service-distance-val");d.on("input",function(e){var f=d.val(),g=/^\d*$/;""!=f&&(""!==f&&g.test(f)?c&&a._getData(f,c.currentCar):b.showError("请输入正确的公里数。"),a._disableServicesHtml())}),$(".j-service-info-car").on("click",function(a){location.href="#car/"})},_getData:function(a,c){var d=this;b.get({url:sharpApi.getsugschemes,data:{mile:a,bid:c.bid,sid:c.sid,cid:c.cid,skm:c.skm,dkm:c.dkm},success:function(a){var b=a.result;if(0==b.length)return!1;$.each(b,function(a,b){b.scname.indexOf("(推荐)")>0?(b.recommend=1,b.scname=b.scname.split("(推荐)")[0]):b.recommend=0});var c={result:b};d._renderHtml(c)}})},_renderHtml:function(a){var b=this;dust.render("template/service_info",a,function(a,b){$(".j-services-listdom").removeClass("hide").html(b)}),b._bindHtmlEvent()},_bindHtmlEvent:function(){var a=this;$(".j-service-list-item").on("click",function(b){$(".j-service-list-item.check").removeClass("check"),$this=$(b.currentTarget),$this.addClass("check"),a.orderInfo.order_name=$this.data("sname");var c=$this.attr("data-mileage");""!==c&&a._getCareListData(c)})},handlerBaseCare:function(a){for(var b=[],c=[],d={},e={},f=0;3>f;f++){var g=a[f];b.push(g.name);for(var h=0,i=g.list,j=0;j<i.length;j++){var k=i[j].scname;d[k]?d[k]+=1:d[k]=1,h+=Number(i[j].scsumprice),1===f&&(e[k]=i[j].scsumprice)}var l={};l.carelist=i,l.sumprice=h,l.tname=g.name,c.push(l)}for(var f=0;3>f;f++){for(var l=c[f].carelist,m=[],n=[],o=[],j=0;j<l.length;j++){var p=d[l[j].scname];if(3==p){var q=Number(e[l[j].scname]);q&&(0==f&&Number(l[j].scsumprice)<q&&(l[j].green="green"),2==f&&Number(l[j].scsumprice)>q&&(l[j].red="red")),m.push(l[j])}else 2==p?n.push(l[j]):1==p&&o.push(l[j])}var i=m.sort(function(a,b){return a.scname>b.scname}).concat(n);i=i.concat(o),c[f].carelist=i}return{tnames:b,baseCare:c}},handlerSugsCare:function(a){return a},_getCareListData:function(a,c){var d=this,e=d._otherInfoData.currentCar;b.map&&b.map.address.city.replace("市","")||"北京";b.get({url:sharpApi.getcarschemes,data:{mile:a,bid:e.bid,sid:e.sid,cid:e.cid},success:function(a){var c=a.result;if(c.basecare){var e=d.handlerBaseCare(c.basecare);c.basecare=e.baseCare,c.tnames0=e.tnames[0],c.tnames1=e.tnames[1],c.tnames2=e.tnames[2]}if(c.sugscare){var f=d.handlerSugsCare(c.sugscare);c.sugscare=f}b.setLocalData("serviceCareDetail",c),d._renderCare(c)}})},_renderCare:function(a){var b=this;dust.render("template/service_list",a,function(a,c){$(".j-services-carelist").html(c),b._priceAll()}),b._bindCareEvent(),b._sugsEvents()},_bindCareEvent:function(){var a=this,f=$(".c-service-box");setTimeout(function(){var b=Math.round(f.offset().top+d.scrollTop()-e);a._scrollTop(b)},600);var g=1,h=$(".j-service-menu"),i=h.find(".c-service-middle");h.find("li").on("click",function(b){var c=$(this),d=c.data("index");if(d!=g){h.find(".check").removeClass("check"),c.addClass("check");var e=$(".c-service-base .check"),f=$(".j-service-base"+d);e.removeClass("check"),f.addClass("check"),1==d?i.css("border-width",1):2==d?i.css("border-right-width",0).css("border-left-width",1):0==d&&i.css("border-right-width",1).css("border-left-width",0),g=d,a._priceAll()}}),$(".j-services-btn-bottom").on("click",function(d){var e=$(d.target);if(e.hasClass("c-service-taocan-info"))return c.init({hasHead:!0,confirm:"知道了",title:"套餐组合说明",content:'<div class="c-service-dialog-illustrate">此公里数下的保养项目主要来源于车主使用手册,车主需要按照车主手册上的保养周期进行正确的保养， 以确保车辆处于最佳状态,如车辆在恶劣环境下行驶,则需要更频繁地进行保养,有助于确保行车安全， 这些保养通常不在车辆的保修范围内， 车主需要支付使用的工时及配件费用。</div>',dom:"#services"}),!1;if(e.hasClass("c-service-detail-info")){var f=$(".j-service-menu .check").data("index"),g=b.getLocalData("serviceCareDetail");return $.extend(g,{index:f}),dust.render("template/services_table",g,function(b,d){c.init({hasHead:!1,confirm:"知道了",title:"提示",content:d,dom:"#services",bindEvent:a._bindServiceTableEvent})}),!1}})},_bindServiceTableEvent:function(){function a(a){var b=$(".j-service-table-menu .c-service-middle");1==a?b.css("border-width",1):2==a?b.css("border-right-width",0).css("border-left-width",1):0==a&&b.css("border-right-width",1).css("border-left-width",0)}var b=$(".j-service-menu .check").data("index");a(b),$(".j-service-table-menu li")[b].classList.add("check"),$(".j-service-table-menu").on("click",function(c){var d=$(c.target),e=d.data("index");if(e!=b){b=e,$(this).find(".check").removeClass("check"),d.addClass("check"),$(".c-service-table.check").removeClass("check");var f=$(".j-service-table"+e);f.addClass("check"),a(e)}})},_sugsEvents:function(){var a=this;$(".j-service-sugs-item").on("click",function(b){var c=$(b.currentTarget);c.toggleClass("check"),a._priceAll()})},getCheckBaseCare:function(){var a="",b=[],c="";return $(".c-service-base .check .j-service-base-subitem").each(function(d,e){var f=$(e);a+=["(",f.find(".j-service-base-cname").text(),"/",f.data("scwprice"),"/",f.data("scpprice"),"/",f.data("subprice"),")"].join(""),b.push(f.data("scid")),c+=[f.data("scid"),"-",f.data("subprice"),"-",f.data("sctoken"),"|"].join("")}),{desc:a,scid:b,sctoken:c}},getCheckSugsCare:function(){var a="",b=[],c="";return $(".c-service-sugs-item.check").each(function(d,e){var f=$(e);a+=["(",f.find(".j-service-sugs-name").text(),"/",f.data("scwprice"),"/",f.data("scpprice"),"/",f.data("subprice"),")"].join(""),b.push(f.data("scid")),c+=[f.data("scid"),"-",f.data("subprice"),"-",f.data("sctoken"),"|"].join("")}),{desc:a,scid:b,sctoken:c}},_cacheData:function(a){var b=this,c=b.getCheckBaseCare(),d=b.getCheckSugsCare();b.orderInfo.order_desc=c.desc+"#"+d.desc;var e=(c.sctoken+d.sctoken).replace(/\|{1,2}$/,""),f="";c.scid.length>0&&(f+=c.scid.join("-")),d.scid.length>0&&(f+="-"+d.scid.join("-")),b.orderInfo.goods_id=f.slice(0,49),b.orderInfo.sctoken=e,b.orderInfo.base_price=$(".check .j-service-base-total").data("sump")},_priceAll:function(){var a=this,b=0,c=$(".c-service-base .check .j-service-base-total").data("sump");return $(".c-service-sugs-item.check").each(function(a,c){b+=Number(c.dataset.subprice)}),b+=parseFloat(c),$(".j-services-price-num").text(b.toFixed(2)),$(".j-price-button").removeClass("disabled"),a.orderInfo.order_price=b,{priceall:b}},_scrollTop:function(a){function b(){f>=g||(f++,d.scrollTop((a-e)/g*f+e),c(b))}function c(a){return window.requestAnimationFrame?window.requestAnimationFrame(a):window.webkitRequestAnimationFrame?window.webkitRequestAnimationFrame(a):void 0}var e=parseFloat(d.offset().top),f=0,a=parseFloat(a),g=5;b()}};module.exports={init:a}});