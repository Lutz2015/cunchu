define(function(require,exports,module){function a(){var a={};if(j.getLocalData("hasOldCar"))var b=j.getLocalData("myCar").currentCar;else var b=j.getLocalData("otherInfo").currentCar;if(2==j.getLocalData("changeOldCar")){var c=j.getLocalData("otherInfo").newCar;a.cname=c.bname+c.sname+c.cname,a.cid=c.cid}else a.cid=b.cid,b.bname&&b.sname?a.cname=b.bname+b.sname+b.cname:a.cname=b.cname;return b.ucid&&(a.ucid=b.ucid),b.ucdate&&(a.ucdate=b.ucdate),b.uccode?(a.uccode1=b.uccode.match(/^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使]{1}|WJ/)[0],a.uccode2=b.uccode.replace(/^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使]{1}|WJ/,"")):a.uccode1="京",a}function b(){i=a(),k.render("template/addcar",i,function(a,b){m.html(b),d()})}function c(){var a=new $.Deferred;return j.get({url:l.getShopList,success:function(b){a.resolve(b.result)}}),a}function d(){var a=$(".j-addcar-uccode1");a.on("click",function(b){var c=require("widget/uccode/js/uccode"),d=a.find(".j-addcar-uccode1-text");c.init({appendDom:"#addcar",text:d.text(),callback:function(a){d.text(a)}})});var b=$(".c-addcar-uccode2");b.on("focus",function(a){b.hasClass("red")&&(b.val(""),b.removeClass("red"))}),$(".j-addcar-select-car").on("click",function(a){j.setLocalData("changeOldCar",!0),location.href="#carselect/"});var d=$(".j-addcar-date"),g=$(".c-date-placeholder");d.on("focus",function(a){g.addClass("hide")}),d.on("blur",function(a){d.val()||g.removeClass("hide")}),g.on("click",function(a){d.focus()}),$(".j-addcar-submit").on("click",function(d){if(!b.hasClass("red")){var g=$.trim(b.val()).toLocaleUpperCase();if(""==g)return void b.addClass("red").val("请输入车牌号");var h=a.text()+g;if(!/^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼]{1}[A-Z]{1}[0-9,A-Z]{5}$/.test(h))return void j.showError("您输入的车牌格式不正确");var k=$(".j-addcar-date").val();if(!k)return void j.showError("请选择购车日期");if(new Date(k).getTime()>(new Date).getTime())return void j.showError("您输入的日期大于当前日期");var l=$(".j-addcar-select-car"),m=l.data("cid");j.getLocalData("hasOldCar")&&i.cid==m&&i.ucdate==k&&i.uccode==h&&(location.href="#mycar/");var n={cid:m,uccode:h,ucdate:k};if(j.getLocalData("hasOldCar")){n.ucid=l.data("ucid");var o=f(n)}else var o=e(n);o.then(function(a){if(0==a)return void j.showError("汽车牌照重复，请重新填写。");if(j.getLocalData("hasOldCar")||j.getLocalData("isFromMyCar"))location.href="#mycar/";else{var b=j.getLocalData("otherInfo"),d=b.currentCar;d.uccode=n.uccode,d.ucid=a,d.cname=d.bname+d.sname+d.cname;var e=c();e.then(function(a){a.length>1?(j.setLocalData("otherInfo",b),location.href="#shop/"):1==a.length&&(b.currentShop=a[0],j.setLocalData("otherInfo",b),location.href="#services/")})}})}}),$(".j-addcar-delete").on("click",function(a){n.init({hasCancel:!0,hasHead:!1,confirm:"确认删除",content:'<div class="c-delete-car-confirm-info">确认删除该车辆信息吗？</div>',dom:"#addcar",thirty:!0,callback:function(){j.post({url:l.deleteUserCar,data:{ucid:$(".j-addcar-select-car").data("ucid")},success:function(a){location.href="#mycar/"}})}})})}function e(a){var b=new $.Deferred;return j.post({url:l.addUserCar,data:a,success:function(a){b.resolve(a.result)}}),b}function f(a){var b=new $.Deferred;return j.post({url:l.updateUserCar,data:a,success:function(a){b.resolve(a.result)}}),b}function g(){if(j.isBox)return!1;var a=require("widget/head/js/head");a.init({hasBack:1,hasHref:"http://www.baidu.com",title:o,dom:"#addcarhead",loginout:0})}function h(){j.getLocalData("hasOldCar")&&(o="修改爱车"),$(".c-uccode-select").remove(),g(),b(),j.toggleContent("#addcar")}require("template/addcar");var i,j=window.sharp,k=window.dust,l=window.sharpApi,m=$("#addcarcontent"),n=require("widget/dialog/js/dialog"),o="添加爱车";module.exports={init:h}});