define(function(require,exports,module){require("template/payorder");var a=(require("widget/tips/js/tips"),$("#payorder")),b=a.find(".content"),c={renderHead:function(){if(sharp.isBox)return document.title="订单填写",!1;var a=require("widget/head/js/head");a.init({dom:"#payorder .comhead",hasBack:1,title:"订单填写",opt:1})},_init:function(){var a=this;b.html()||a.renderHead();var c=sharp.getLocalData("otherInfo");a.currentCar=c.currentCar,a.currentShop=c.currentShop,a.personInfo=sharp.getLocalData("personInfo");var d=sharp.getLocalData("orderInfo");a.orderInfo={sp_no:a.currentShop.sp_no,logo:a.currentCar.logo,uccode:a.currentCar.uccode,cname:a.currentCar.cname,goods_id:d.goods_id,goods_name:d.order_name,goods_desc:d.order_desc,user_name:a.personInfo.uname,user_phone:a.personInfo.phone,service_time:"",total_amount:d.order_price,sctoken:d.sctoken,remark:""},a._renderTpl()},_renderTpl:function(){var c=this,d=c.currentCar,e=c.currentShop,f=c._handleCares(),g={cname:d.cname,uccode:d.uccode,logo:d.logo,ucid:d.ucid,sp_address:e.sp_address,sp_name:e.sp_name,phone:c.personInfo.phone,carLogo:carLogo,cares:f};dust.render("template/payorder",g,function(c,d){b.html(d),a.attr("hasRender",!0)}),c._bindEvents()},_handleCares:function(){var a=sharp.getLocalData("orderInfo");$(".j-order-price-num").text(a.order_price);var b=[],c={name:a.order_name,price:a.base_price};b.push(c);var d=a.order_desc.split("#")[1];if(d)for(var e=d.replace(/\(/g,"").split(")"),f=0,g=e.length;g>f;f++)if(e[f]){var h=e[f].split("/");b.push({name:h[0],price:h[3]})}return b},_createOrder:function(){var a=this,b=a.orderInfo;sharp.post({url:sharpApi.orderPay,data:b,success:function(a){location.href=a.result.url}})},_bindEvents:function(){var a=this,b=$(".j-order-user-name");b.on("focus",function(a){b.hasClass("red")&&b.removeClass("red").val("")});var c=$(".j-order-service-time"),d=$(".c-order-date-placeholder");c.on("focus",function(a){d.addClass("hide")}),c.on("blur",function(a){c.val()||d.removeClass("hide")}),d.on("click",function(a){c.focus()});var e=!1;$(".j-go-to-pay").on("click",function(){if(e)return!1;if(e=!0,b.hasClass("red"))return e=!1,!1;var c=$.trim(b.val());if(!c)return b.addClass("red").val("请输入您的姓名。"),e=!1,!1;if(c.replace(/[\u4e00-\u9fa5]/g,"ss").length>12)return sharp.showError("姓名只能输入12个字符以内。"),e=!1,!1;if(!/^[a-zA-Z\u4e00-\u9fa5]+$/.test(c))return sharp.showError("姓名只能输入中文或英文。"),e=!1,!1;a.orderInfo.user_name=c;var d=$.trim($(".j-order-user-phone").val());if(!d)return sharp.showError("请输入您的电话。"),e=!1,!1;if(!/^1[3578][0-9]{9}$/.test(d))return sharp.showError("请输入正确的手机号码。"),e=!1,!1;a.orderInfo.user_phone=d;var f=$.trim($(".j-order-service-time").val());if(""==f)return sharp.showError("请输入服务日期。"),e=!1,!1;var g=new Date,h=g.getFullYear()+"-"+(g.getMonth()+1)+"-"+g.getDate();return new Date(f).getTime()<new Date(h).getTime()?(sharp.showError("您输入的日期小于当前日期"),e=!1,!1):(a.orderInfo.service_time=f+" 23:59:59",void a._createOrder())})}},d=function(){c._init(),sharp.toggleContent("#payorder")};module.exports={init:d}});